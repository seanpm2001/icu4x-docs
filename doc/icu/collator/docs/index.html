<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="This module exists to contain implementation docs and notes for people who want to contribute."><meta name="keywords" content="rust, rustlang, rust-lang, docs"><title>icu::collator::docs - Rust</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" type="text/css" href="../../../normalize.css"><link rel="stylesheet" type="text/css" href="../../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../../../ayu.css" disabled><link rel="stylesheet" type="text/css" href="../../../dark.css" disabled><link rel="stylesheet" type="text/css" href="../../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../../storage.js"></script><script src="../../../crates.js"></script><script defer src="../../../main.js"></script>
    <noscript><link rel="stylesheet" href="../../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../../favicon.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../../icu/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></div>
        </a><h2 class="location"></h2>
    </nav>
    <nav class="sidebar"><a class="sidebar-logo" href="../../../icu/index.html"><div class="logo-container"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></div>
        </a><h2 class="location"><a href="#">Module docs</a></h2><div class="sidebar-elems"><div id="sidebar-vars" data-name="docs" data-ty="mod" data-relpath="./"></div><script defer src="./sidebar-items.js"></script></div></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../../icu/index.html"><img class="rust-logo" src="../../../rust-logo.svg" alt="logo"></a><nav class="sub"><div class="theme-picker hidden"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu" title="themes"><img width="22" height="22" alt="Pick another theme!" src="../../../brush.svg"></button><div id="theme-choices" role="menu"></div></div><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><button type="button" id="help-button" title="help">?</button><a id="settings-menu" href="../../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../../wheel.svg"></a></div></form></nav></div><section id="main-content" class="content"><div class="main-heading">
    <h1 class="fqn"><span class="in-band">Module <a href="../../index.html">icu</a>::<wbr><a href="../index.html">collator</a>::<wbr><a class="mod" href="#">docs</a><button id="copy-path" onclick="copy_path(this)" title="Copy item path to clipboard"><img src="../../../clipboard.svg" width="19" height="18" alt="Copy item path"></button></span></h1><span class="out-of-band"><a class="srclink" href="../../../src/icu_collator/lib.rs.html#290">source</a> · <a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span></div><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>This module exists to contain implementation docs and notes for people who want to contribute.</p>
<h2 id="contributor-notes"><a href="#contributor-notes">Contributor Notes</a></h2><h3 id="development-environment-on-linux-for-fuzzing-and-generating-data"><a href="#development-environment-on-linux-for-fuzzing-and-generating-data">Development environment (on Linux) for fuzzing and generating data</a></h3>
<p>These notes assume that ICU4X itself has been cloned to <code>$PROJECTS/icu4x</code>.</p>
<p>Clone ICU4C from <a href="https://github.com/hsivonen/icu">https://github.com/hsivonen/icu</a> to <code>$PROJECTS/icu</code> and switch
to the branch <code>icu4x-collator</code>.</p>
<p>Create a directory <code>$PROJECTS/localicu</code></p>
<p>Create a directory <code>$PROJECTS/icu-build</code> and <code>cd</code> into it.</p>
<p>Run <code>../icu/icu4c/source/runConfigureICU --enable-debug Linux --prefix $PROJECTS/localicu --enable-static</code></p>
<p>Run <code>make</code></p>
<h4 id="generating-data"><a href="#generating-data">Generating data</a></h4><h4 id="testing"><a href="#testing">Testing</a></h4>
<p><code>cargo test --features serde</code></p>
<h4 id="fuzzing"><a href="#fuzzing">Fuzzing</a></h4>
<p><code>cargo install cargo-fuzz</code></p>
<p>Clone <code>rust_icu</code> from <a href="https://github.com/google/rust_icu">https://github.com/google/rust_icu</a> to <code>$PROJECTS/rust_icu</code>.</p>
<p>In <code>$PROJECTS/icu-build</code> run <code>make install</code>.</p>
<p><code>cd $PROJECTS/icu4x/components/collator</code></p>
<p>Run the fuzzer until a panic:</p>
<p><code>PKG_CONFIG_PATH=&quot;$PROJECTS/localicu/lib/pkgconfig&quot; PATH=&quot;$PROJECTS/localicu/bin:$PATH&quot; LD_LIBRARY_PATH=&quot;/$PROJECTS/localicu/lib&quot; RUSTC_BOOTSTRAP=1 cargo +stable fuzz run compare_utf16</code></p>
<p>Once there is a panic, recompile with debug symbols by adding <code>--dev</code>:</p>
<p><code>PKG_CONFIG_PATH=&quot;$PROJECTS/localicu/lib/pkgconfig&quot; PATH=&quot;$PROJECTS/localicu/bin:$PATH&quot; LD_LIBRARY_PATH=&quot;$PROJECTS/localicu/lib&quot; RUSTC_BOOTSTRAP=1 cargo +stable fuzz run --dev compare_utf16 fuzz/artifacts/compare_utf16/crash-$ARTIFACTHASH</code></p>
<p>Record with</p>
<p><code>LD_LIBRARY_PATH=&quot;$PROJECTS/localicu/lib&quot; rr fuzz/target/x86_64-unknown-linux-gnu/debug/compare_utf16 -artifact_prefix=$PROJECTS/icu4x/components/collator/fuzz/artifacts/compare_utf16/ fuzz/artifacts/compare_utf16/crash-$ARTIFACTHASH</code></p>
<h2 id="design-notes"><a href="#design-notes">Design notes</a></h2>
<ul>
<li>The collation element design comes from ICU4C. Some parts of the ICU4C design, notably,
<code>Tag::BuilderDataTag</code>, <code>Tag::LeadSurrogateTag</code>, <code>Tag::LatinExpansionTag</code>, <code>Tag::U0000Tag</code>,
and <code>Tag::HangulTag</code> are unused.
<ul>
<li><code>Tag::LatinExpansionTag</code> might be reallocated to search expansions for archaic jamo
in the future.</li>
<li><code>Tag::HangulTag</code> might be reallocated to compressed hanja expansions in the future.
See <a href="https://github.com/unicode-org/icu4x/issues/1315">issue 1315</a>.</li>
</ul>
</li>
<li>The key design difference between ICU4C and ICU4X is that ICU4C puts the canonical
closure in the data (larger data) to enable lookup directly by precomposed characters
while ICU4X always omits the canonical closure and always normalizes to NFD on the fly.</li>
<li>Compared to ICU4C, normalization cannot be turned off. There also isn’t a separate
“Fast Latin” mode.</li>
<li>The normalization is fused into the collation element lookup algorithm to optimize the
case where an input character decomposes into two BMP characters: a base letter and a
diacritic.
<ul>
<li>To optimize away a trie lookup when the combining diacritic doesn’t contract,
there is a linear lookup table for the combining diacritics block. Three languages
tailor diacritics: Ewe, Lithuanian, and Vietnamese. Vietnamese and Ewe load an
alternative table. The Lithuanian special cases are hard-coded and activatable by
a metadata bit.</li>
</ul>
</li>
<li>Unfortunately, contractions that contract starters don’t fit this model nicely. Therefore,
there’s duplicated normalization code for normalizing the lookahead for contractions.
This code can, in principle, do duplicative work, but it shouldn’t be excessive with
real-world inputs.</li>
<li>As a result, in terms of code provenance, the algorithms come from ICU4C, except the
normalization part of the code is novel to ICU4X, and the contraction code is custom
to ICU4X despite being informed by ICU4C.</li>
<li>The way input characters are iterated over and resulting collation elements are
buffered is novel to ICU4X.</li>
<li>ICU4C can iterate backwards but ICU4X cannot. ICU4X keeps a buffer of the two most
recent characters for handling prefixes. As of CLDR 40, there were only two kinds
of prefixes: a single starter and a starter followed by a kana voicing mark.</li>
<li>ICU4C sorts unpaired surrogates in their lexical order. ICU4X operates on Unicode
<a href="https://unicode.org/glossary/#unicode_scalar_value">scalar values</a> (any Unicode
code point except high-surrogate and low-surrogate code points), so unpaired
surrogates sort as REPLACEMENT CHARACTERs. Therefore, all unpaired
surrogates are equal with each other.</li>
<li>Skipping over a bit-identical prefix and then going back over “backward-unsafe”
characters is currently unimplemented but isn’t architecturally precluded.</li>
<li>Hangul is handled specially:
<ul>
<li>
<p>Precomposed syllables are checked for as the first step of processing an
incoming character.</p>
</li>
<li>
<p>Individual jamo are lookup up from a linear table instead of a trie. Unlike
in ICU4C, this table covers the whole Unicode block whereas in ICU4C it covers
only modern jamo for use in decomposing the precomposed syllables. The point
is that search collations have a lot of duplicative (across multiple search)
collations data for making archaic jamo searchable by modern jamo.
Unfortunately, the shareable part isn’t currently actually shareable, because
the tailored CE32s refer to the expansions table in each collation. To make
them truly shareable, the archaic jamo expansions need to become self-contained
the way Latin mini expansions in ICU4C are self-contained.</p>
<p>One possible alternative to loading a different table for “search” would be
performing the mapping of archaic jamo to the modern approximations as a
special preprocessing step for the incoming characters, which would allow
the lookup of the resulting modern jamo from the normal root jamo table.</p>
<p>“searchjl” is even more problematic than “search”, since “searchjl” uses
prefixes matches with jamo, and currently Hangul is assumed not to participate
in prefix or contraction matching.</p>
</li>
</ul>
</li>
</ul>
</div></details></section><section id="search" class="content hidden"></section></div></main><div id="rustdoc-vars" data-root-path="../../../" data-current-crate="icu" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.61.0 (fe5b13d68 2022-05-18)" ></div>
</body></html>