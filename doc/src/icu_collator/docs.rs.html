<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Source of the Rust file `components/collator/src/docs.rs`."><meta name="keywords" content="rust, rustlang, rust-lang"><title>docs.rs - source</title><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Regular.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../FiraSans-Medium.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Regular.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceSerif4-Bold.ttf.woff2"><link rel="preload" as="font" type="font/woff2" crossorigin href="../../SourceCodePro-Semibold.ttf.woff2"><link rel="stylesheet" type="text/css" href="../../normalize.css"><link rel="stylesheet" type="text/css" href="../../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../../ayu.css" disabled><link rel="stylesheet" type="text/css" href="../../dark.css" disabled><link rel="stylesheet" type="text/css" href="../../light.css" id="themeStyle"><script id="default-settings" ></script><script src="../../storage.js"></script><script src="../../crates.js"></script><script defer src="../../main.js"></script><script defer src="../../source-script.js"></script><script defer src="../../source-files.js"></script>
    <noscript><link rel="stylesheet" href="../../noscript.css"></noscript><link rel="alternate icon" type="image/png" href="../../favicon-16x16.png"><link rel="alternate icon" type="image/png" href="../../favicon-32x32.png"><link rel="icon" type="image/svg+xml" href="../../favicon.svg"></head><body class="rustdoc source"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle">&#9776;</button><a class="sidebar-logo" href="../../icu_collator/index.html"><div class="logo-container"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></div>
        </a><h2 class="location"></h2>
    </nav>
    <nav class="sidebar"><a class="sidebar-logo" href="../../icu_collator/index.html"><div class="logo-container"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></div>
        </a></nav><main><div class="width-limiter"><div class="sub-container"><a class="sub-logo-container" href="../../icu_collator/index.html"><img class="rust-logo" src="../../rust-logo.svg" alt="logo"></a><nav class="sub"><div class="theme-picker hidden"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu" title="themes"><img width="22" height="22" alt="Pick another theme!" src="../../brush.svg"></button><div id="theme-choices" role="menu"></div></div><form class="search-form"><div class="search-container"><span></span><input class="search-input" name="search" autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"><button type="button" id="help-button" title="help">?</button><a id="settings-menu" href="../../settings.html" title="settings"><img width="22" height="22" alt="Change settings" src="../../wheel.svg"></a></div></form></nav></div><section id="main-content" class="content"><div class="example-wrap"><pre class="line-numbers"><span id="1">1</span>
<span id="2">2</span>
<span id="3">3</span>
<span id="4">4</span>
<span id="5">5</span>
<span id="6">6</span>
<span id="7">7</span>
<span id="8">8</span>
<span id="9">9</span>
<span id="10">10</span>
<span id="11">11</span>
<span id="12">12</span>
<span id="13">13</span>
<span id="14">14</span>
<span id="15">15</span>
<span id="16">16</span>
<span id="17">17</span>
<span id="18">18</span>
<span id="19">19</span>
<span id="20">20</span>
<span id="21">21</span>
<span id="22">22</span>
<span id="23">23</span>
<span id="24">24</span>
<span id="25">25</span>
<span id="26">26</span>
<span id="27">27</span>
<span id="28">28</span>
<span id="29">29</span>
<span id="30">30</span>
<span id="31">31</span>
<span id="32">32</span>
<span id="33">33</span>
<span id="34">34</span>
<span id="35">35</span>
<span id="36">36</span>
<span id="37">37</span>
<span id="38">38</span>
<span id="39">39</span>
<span id="40">40</span>
<span id="41">41</span>
<span id="42">42</span>
<span id="43">43</span>
<span id="44">44</span>
<span id="45">45</span>
<span id="46">46</span>
<span id="47">47</span>
<span id="48">48</span>
<span id="49">49</span>
<span id="50">50</span>
<span id="51">51</span>
<span id="52">52</span>
<span id="53">53</span>
<span id="54">54</span>
<span id="55">55</span>
<span id="56">56</span>
<span id="57">57</span>
<span id="58">58</span>
<span id="59">59</span>
<span id="60">60</span>
<span id="61">61</span>
<span id="62">62</span>
<span id="63">63</span>
<span id="64">64</span>
<span id="65">65</span>
<span id="66">66</span>
<span id="67">67</span>
<span id="68">68</span>
<span id="69">69</span>
<span id="70">70</span>
<span id="71">71</span>
<span id="72">72</span>
<span id="73">73</span>
<span id="74">74</span>
<span id="75">75</span>
<span id="76">76</span>
<span id="77">77</span>
<span id="78">78</span>
<span id="79">79</span>
<span id="80">80</span>
<span id="81">81</span>
<span id="82">82</span>
<span id="83">83</span>
<span id="84">84</span>
<span id="85">85</span>
<span id="86">86</span>
<span id="87">87</span>
<span id="88">88</span>
<span id="89">89</span>
<span id="90">90</span>
<span id="91">91</span>
<span id="92">92</span>
<span id="93">93</span>
<span id="94">94</span>
<span id="95">95</span>
<span id="96">96</span>
<span id="97">97</span>
<span id="98">98</span>
<span id="99">99</span>
<span id="100">100</span>
<span id="101">101</span>
<span id="102">102</span>
<span id="103">103</span>
<span id="104">104</span>
<span id="105">105</span>
<span id="106">106</span>
<span id="107">107</span>
<span id="108">108</span>
<span id="109">109</span>
<span id="110">110</span>
<span id="111">111</span>
<span id="112">112</span>
<span id="113">113</span>
<span id="114">114</span>
<span id="115">115</span>
<span id="116">116</span>
<span id="117">117</span>
<span id="118">118</span>
<span id="119">119</span>
<span id="120">120</span>
<span id="121">121</span>
<span id="122">122</span>
<span id="123">123</span>
<span id="124">124</span>
<span id="125">125</span>
<span id="126">126</span>
<span id="127">127</span>
<span id="128">128</span>
<span id="129">129</span>
<span id="130">130</span>
<span id="131">131</span>
<span id="132">132</span>
<span id="133">133</span>
<span id="134">134</span>
<span id="135">135</span>
<span id="136">136</span>
<span id="137">137</span>
<span id="138">138</span>
<span id="139">139</span>
<span id="140">140</span>
<span id="141">141</span>
<span id="142">142</span>
<span id="143">143</span>
<span id="144">144</span>
<span id="145">145</span>
<span id="146">146</span>
<span id="147">147</span>
<span id="148">148</span>
<span id="149">149</span>
<span id="150">150</span>
<span id="151">151</span>
<span id="152">152</span>
<span id="153">153</span>
<span id="154">154</span>
<span id="155">155</span>
<span id="156">156</span>
<span id="157">157</span>
<span id="158">158</span>
<span id="159">159</span>
</pre><pre class="rust"><code><span class="comment">// This file is part of ICU4X. For terms of use, please see the file</span>
<span class="comment">// called LICENSE at the top level of the ICU4X source tree</span>
<span class="comment">// (online at: https://github.com/unicode-org/icu4x/blob/main/LICENSE ).</span>

<span class="doccomment">//! This module exists to contain implementation docs and notes for people who want to contribute.</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! # Contributor Notes</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! ## Development environment (on Linux) for fuzzing and generating data</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! These notes assume that ICU4X itself has been cloned to `$PROJECTS/icu4x`.</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! Clone ICU4C from &lt;https://github.com/hsivonen/icu&gt; to `$PROJECTS/icu` and switch</span>
<span class="doccomment">//! to the branch `icu4x-collator`.</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! Create a directory `$PROJECTS/localicu`</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! Create a directory `$PROJECTS/icu-build` and `cd` into it.</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! Run `../icu/icu4c/source/runConfigureICU --enable-debug Linux --prefix $PROJECTS/localicu --enable-static`</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! Run `make`</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! ### Generating data</span>
<span class="doccomment">//!</span>
<span class="doccomment">//!</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! ### Testing</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! `cargo test --features serde`</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! Note: some tests depend on collation test data files.</span>
<span class="doccomment">//! These files are copied from the ICU and CLDR codebases,</span>
<span class="doccomment">//! and they are stored in `tests/data/`.</span>
<span class="doccomment">//! New versions of collation data from CLDR/ICU are kept in sync with these collation test data files.</span>
<span class="doccomment">//! When updating ICU4X to pick up new Unicode data, including collation data, from ICU,</span>
<span class="doccomment">//! the copies of collation test data files in maintained in ICU4X&#39;s icu_collator will need to be overridden with their newer corresponding versions.</span>
<span class="doccomment">//! See the Readme in `/tests/data/README.md` for details.</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! ### Fuzzing</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! `cargo install cargo-fuzz`</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! Clone `rust_icu` from &lt;https://github.com/google/rust_icu&gt; to `$PROJECTS/rust_icu`.</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! In `$PROJECTS/icu-build` run `make install`.</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! `cd $PROJECTS/icu4x/components/collator`</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! Run the fuzzer until a panic:</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! `PKG_CONFIG_PATH=&quot;$PROJECTS/localicu/lib/pkgconfig&quot; PATH=&quot;$PROJECTS/localicu/bin:$PATH&quot; LD_LIBRARY_PATH=&quot;/$PROJECTS/localicu/lib&quot; RUSTC_BOOTSTRAP=1 cargo +stable fuzz run compare_utf16`</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! Once there is a panic, recompile with debug symbols by adding `--dev`:</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! `PKG_CONFIG_PATH=&quot;$PROJECTS/localicu/lib/pkgconfig&quot; PATH=&quot;$PROJECTS/localicu/bin:$PATH&quot; LD_LIBRARY_PATH=&quot;$PROJECTS/localicu/lib&quot; RUSTC_BOOTSTRAP=1 cargo +stable fuzz run --dev compare_utf16 fuzz/artifacts/compare_utf16/crash-$ARTIFACTHASH`</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! Record with</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! `LD_LIBRARY_PATH=&quot;$PROJECTS/localicu/lib&quot; rr fuzz/target/x86_64-unknown-linux-gnu/debug/compare_utf16 -artifact_prefix=$PROJECTS/icu4x/components/collator/fuzz/artifacts/compare_utf16/ fuzz/artifacts/compare_utf16/crash-$ARTIFACTHASH`</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! # Design notes</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! * The collation element design comes from ICU4C. Some parts of the ICU4C design, notably,</span>
<span class="doccomment">//!   `Tag::BuilderDataTag`, `Tag::LeadSurrogateTag`, `Tag::LatinExpansionTag`, `Tag::U0000Tag`,</span>
<span class="doccomment">//!   and `Tag::HangulTag` are unused.</span>
<span class="doccomment">//!   - `Tag::LatinExpansionTag` might be reallocated to search expansions for archaic jamo</span>
<span class="doccomment">//!     in the future.</span>
<span class="doccomment">//!   - `Tag::HangulTag` might be reallocated to compressed hanja expansions in the future.</span>
<span class="doccomment">//!     See [issue 1315](https://github.com/unicode-org/icu4x/issues/1315).</span>
<span class="doccomment">//! * The key design difference between ICU4C and ICU4X is that ICU4C puts the canonical</span>
<span class="doccomment">//!   closure in the data (larger data) to enable lookup directly by precomposed characters</span>
<span class="doccomment">//!   while ICU4X always omits the canonical closure and always normalizes to NFD on the fly.</span>
<span class="doccomment">//! * Compared to ICU4C, normalization cannot be turned off. There also isn&#39;t a separate</span>
<span class="doccomment">//!   &quot;Fast Latin&quot; mode.</span>
<span class="doccomment">//! * The normalization is fused into the collation element lookup algorithm to optimize the</span>
<span class="doccomment">//!   case where an input character decomposes into two BMP characters: a base letter and a</span>
<span class="doccomment">//!   diacritic.</span>
<span class="doccomment">//!   - To optimize away a trie lookup when the combining diacritic doesn&#39;t contract,</span>
<span class="doccomment">//!     there is a linear lookup table for the combining diacritics block. Three languages</span>
<span class="doccomment">//!     tailor diacritics: Ewe, Lithuanian, and Vietnamese. Vietnamese and Ewe load an</span>
<span class="doccomment">//!     alternative table. The Lithuanian special cases are hard-coded and activatable by</span>
<span class="doccomment">//!     a metadata bit.</span>
<span class="doccomment">//! * Unfortunately, contractions that contract starters don&#39;t fit this model nicely. Therefore,</span>
<span class="doccomment">//!   there&#39;s duplicated normalization code for normalizing the lookahead for contractions.</span>
<span class="doccomment">//!   This code can, in principle, do duplicative work, but it shouldn&#39;t be excessive with</span>
<span class="doccomment">//!   real-world inputs.</span>
<span class="doccomment">//! * As a result, in terms of code provenance, the algorithms come from ICU4C, except the</span>
<span class="doccomment">//!   normalization part of the code is novel to ICU4X, and the contraction code is custom</span>
<span class="doccomment">//!   to ICU4X despite being informed by ICU4C.</span>
<span class="doccomment">//! * The way input characters are iterated over and resulting collation elements are</span>
<span class="doccomment">//!   buffered is novel to ICU4X.</span>
<span class="doccomment">//! * ICU4C can iterate backwards but ICU4X cannot. ICU4X keeps a buffer of the two most</span>
<span class="doccomment">//!   recent characters for handling prefixes. As of CLDR 40, there were only two kinds</span>
<span class="doccomment">//!   of prefixes: a single starter and a starter followed by a kana voicing mark.</span>
<span class="doccomment">//! * ICU4C sorts unpaired surrogates in their lexical order. ICU4X operates on Unicode</span>
<span class="doccomment">//!   [scalar values](https://unicode.org/glossary/#unicode_scalar_value) (any Unicode</span>
<span class="doccomment">//!   code point except high-surrogate and low-surrogate code points), so unpaired</span>
<span class="doccomment">//!   surrogates sort as REPLACEMENT CHARACTERs. Therefore, all unpaired</span>
<span class="doccomment">//!   surrogates are equal with each other.</span>
<span class="doccomment">//! * Skipping over a bit-identical prefix and then going back over &quot;backward-unsafe&quot;</span>
<span class="doccomment">//!   characters is currently unimplemented but isn&#39;t architecturally precluded.</span>
<span class="doccomment">//! * Hangul is handled specially:</span>
<span class="doccomment">//!   - Precomposed syllables are checked for as the first step of processing an</span>
<span class="doccomment">//!     incoming character.</span>
<span class="doccomment">//!   - Individual jamo are lookup up from a linear table instead of a trie. Unlike</span>
<span class="doccomment">//!     in ICU4C, this table covers the whole Unicode block whereas in ICU4C it covers</span>
<span class="doccomment">//!     only modern jamo for use in decomposing the precomposed syllables. The point</span>
<span class="doccomment">//!     is that search collations have a lot of duplicative (across multiple search)</span>
<span class="doccomment">//!     collations data for making archaic jamo searchable by modern jamo.</span>
<span class="doccomment">//!     Unfortunately, the shareable part isn&#39;t currently actually shareable, because</span>
<span class="doccomment">//!     the tailored CE32s refer to the expansions table in each collation. To make</span>
<span class="doccomment">//!     them truly shareable, the archaic jamo expansions need to become self-contained</span>
<span class="doccomment">//!     the way Latin mini expansions in ICU4C are self-contained.</span>
<span class="doccomment">//!</span>
<span class="doccomment">//!     One possible alternative to loading a different table for &quot;search&quot; would be</span>
<span class="doccomment">//!     performing the mapping of archaic jamo to the modern approximations as a</span>
<span class="doccomment">//!     special preprocessing step for the incoming characters, which would allow</span>
<span class="doccomment">//!     the lookup of the resulting modern jamo from the normal root jamo table.</span>
<span class="doccomment">//!</span>
<span class="doccomment">//!     &quot;searchjl&quot; is even more problematic than &quot;search&quot;, since &quot;searchjl&quot; uses</span>
<span class="doccomment">//!     prefixes matches with jamo, and currently Hangul is assumed not to participate</span>
<span class="doccomment">//!     in prefix or contraction matching.</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! # Notes about index generation</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! ICU4X currently does not have code or data for generating [collation</span>
<span class="doccomment">//! indexes](https://www.unicode.org/reports/tr35/tr35-collation.html#Collation_Indexes).</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! On the data side, ICU4X doesn&#39;t have data for `&lt;exemplarCharacters type=&quot;index&quot;&gt;`</span>
<span class="doccomment">//! (or when that&#39;s missing, plain `&lt;exemplarCharacters&gt;`).</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! Of the collations, `zh-u-co-pinyin`, `zh-u-co-stroke`, `zh-u-co-zhuyin`, and</span>
<span class="doccomment">//! `*-u-co-unihan` are special: They bake a contraction of U+FDD0 and an index</span>
<span class="doccomment">//! character in the collation order. ICU4X collation data already includes this.</span>
<span class="doccomment">//! For `*-u-co-unihan` this index character data is repeated in all three tailorings</span>
<span class="doccomment">//! instead of being in the root. If it was in the root, code for extracting the</span>
<span class="doccomment">//! index characters from the collation data would need to avoid confusing the</span>
<span class="doccomment">//! `unihan` index contractions (if they were in the root) and the `zh-u-co-pinyin`,</span>
<span class="doccomment">//! `zh-u-co-stroke`, and `zh-u-co-zhuyin` in the tailoring. This seems feasible,</span>
<span class="doccomment">//! but isn&#39;t how CLDR and ICU4C do it. (If the index characters for</span>
<span class="doccomment">//! `*-u-co-unihan` were in the root, `ko-u-co-unihan` would become a mere</span>
<span class="doccomment">//! script reordering.)</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! It&#39;s unclear how useful it would be size-wise to have code to extract the</span>
<span class="doccomment">//! index characters from the collations: For `zh-u-co-pinyin`, `zh-u-co-stroke`,</span>
<span class="doccomment">//! `zh-u-co-zhuyin`, the index characters are contiguous ranges that could be</span>
<span class="doccomment">//! efficiently stored as start and end. Moreover, the in-data index character</span>
<span class="doccomment">//! for `stroke` isn&#39;t the label to be rendered to the user, so special-casing</span>
<span class="doccomment">//! is needed anyway.</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! This means that there&#39;s a tradeoff between having duplicate data (relative to</span>
<span class="doccomment">//! the collation tailorings) for the `unihan` index character list vs. having</span>
<span class="doccomment">//! code for extracting the list from the tailorings. It&#39;s not at all clear that</span>
<span class="doccomment">//! having the code is better for size than having the list of 238 ideographs</span>
<span class="doccomment">//! itself as data (476 bytes as UTF-16).</span>
<span class="doccomment">//!</span>
<span class="doccomment">//! Note: Investigate [#2723](https://github.com/unicode-org/icu4x/issues/2723)</span>
<span class="doccomment">//!</span>
</code></pre></div>
</section><section id="search" class="content hidden"></section></div></main><div id="rustdoc-vars" data-root-path="../../" data-current-crate="icu_collator" data-themes="ayu,dark,light" data-resource-suffix="" data-rustdoc-version="1.61.0 (fe5b13d68 2022-05-18)" ></div>
</body></html>